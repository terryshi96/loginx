#!/usr/bin/env ruby
# coding: utf-8
require 'optparse'
require 'methadone'
require 'loginx.rb'
require 'list.rb'
require 'yaml'
require 'setuser.rb'
require 'setport.rb'
require 'add.rb'
require 'delete.rb'
require 'core.rb'


class App
  include Methadone::Main
  include Methadone::CLILogging
  include Methadone::SH

  main do |arguments|

    #initialize
    config_path = '../config/loginx.yml'

    if File.exist? ("#{config_path}")
    else
      file = File.new("#{config_path}","w")
      file << "config:\n"
      file << " user: root\n"
      file << " port: 22"
      file.close
    end

    #input control
    if options.empty? && ARGV.empty?
      puts 'please use "loginx -h" for more infomation'
      exit 1
    end

  end



  description "login quickly without entering password and support generating&&sending ssh_key\n"
  arg :arguments, :optional
  version Loginx::VERSION



  #option -L in list.rb
  on("-L","list all projects") do
    options[:L] = true
    list = List.new("default")
    list.list_all
  end

  #option -l in list.rb
  on("-l project","list servers under a project") do |project_name|
    options[:l] = project_name
    list = List.new(project_name)
    list.list_project(project_name)
  end

  #option -a in add.rb
  on("-a project server_alias ip password","add a new record") do |project_name|
      options[:a] = project_name
      if ARGV.count != 3
        puts "you must offer server_alias ip and password"
        exit 1
      end
      server_alias = ARGV.shift
      ip = ARGV.shift
      password = ARGV.shift
      record = ADD.new(server_alias,ip,password)
      record.add_record(project_name)
  end

  #option -d in delete.rb
  on("-d project server_alias","delete a record") do |project_name|
    options[:d] = project_name
    if ARGV.count != 1 && ARGV.count != 0
      puts "need project and server alias or just project"
      exit 1
    end
    if ARGV.empty?
      record = Delete.new
      record.del_file(project_name)
      exit 0
    end
    server_alias = ARGV.shift
    record = Delete.new(server_alias)
    record.del_record(project_name)
  end

  #option -u in Setuser.rb
  on("-u user","set user (default root)") do |user|
    options[:u] = user
    set = Setuser.new(options[:u])
    set.update
    puts "now default user is #{set.user}"

  end

  #option -p in Setport.rb
  on("-p Port","set port (default 22)") do |value|
    options[:p] = value
    set = Setport.new(options[:p])
    set.update
    puts "now default port is #{set.port}"
  end

  go!

end
